pkgname=libhybris
pkgver=115.b389ac4
pkgrel=1
arch="all"
url="https://github.com/libhybris/libhybris"
license="Apache"
makedepends="autoconf automake libtool wayland-dev linux-headers bsd-compat-headers android-headers-caf"
_rev=013cf7e07e38d1f15e3cf82743533d496d5420b7
source="$pkgname-$_rev.tar.gz::https://github.com/NotKit/libhybris/archive/$_rev.tar.gz"
pkgdesc="libhybris allows to use bionic-based HW adaptations"
subpackages="$pkgname-dev $pkgname-egl $pkgname-gles $pkgname-libwayland-egl:_wayland"

builddir="$srcdir/$pkgname-$_rev"

build() {
    cd "$builddir/hybris"

    ./autogen.sh \
        --prefix=/usr \
        --enable-wayland \
        --enable-trace \
        --enable-debug \
        --enable-experimental \
        --with-android-headers=/usr/include/android \
        --with-default-hybris-ld-library-path=/usr/libexec/droid-hybris:/system/lib:/vendor/lib:/system/lib \
        --enable-property-cache
    make
}

package() {
    cd "$builddir/hybris"

    make DESTDIR="${pkgdir}" install
}

egl() {
    pkgdesc="libhybris libEGL runtime libraries"
    install -d "$subpkgdir"/usr/lib
    mv "$pkgdir"/usr/lib/libEGL.so.* \
        "$subpkgdir"/usr/lib/
}

gles() {
    pkgdesc="libhybris libGLESv2 runtime libraries"
    install -d "$subpkgdir"/usr/lib
    mv "$pkgdir"/usr/lib/libGLES*.so.* \
        "$subpkgdir"/usr/lib/
}

_wayland() {
    pkgdesc="libhybris libwayland-egl library"
    mkdir -p "$subpkgdir"/usr/lib
    mv "$pkgdir"/usr/lib/libwayland-egl.so.* "$subpkgdir"/usr/lib/ \
        || return 1
}

dev() {
    default_dev

    # Avoid conflicts with mesa-dev
    rm -f "$subpkgdir"/usr/lib/lib*GL*.so
    rm -f "$subpkgdir"/usr/lib/libwayland-egl.so

    cd "$subpkgdir"/usr/lib/pkgconfig
    rm -f egl.pc glesv*.pc wayland-egl.pc

    cd "$subpkgdir"/usr/include
    # Move libhybris-provided headers into hybris dir
    mv CL EGL GLES GLES2 KHR VG hybris

    # Symlink eglhybris.h
    mkdir -p EGL
    cd EGL
    ln -s ../hybris/EGL/eglhybris.h .
}

sha512sums="b0b66efb3fa1c32ddf48477feeeb885c7919f7cb68b9173b6614103e0d88d7c6bf6893324e04b39d6c36b50020d07530c711c7b143eb8ab576f3efda919dc1c7  libhybris-013cf7e07e38d1f15e3cf82743533d496d5420b7.tar.gz"
